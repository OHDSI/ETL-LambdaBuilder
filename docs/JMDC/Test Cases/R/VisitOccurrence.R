# Visit occurrence ------------------------------------------------------------------

set_defaults_claim(paper_claim_flag = NULL, admission_date = NULL, discharge_date = NULL)

declareTest(401, "Visit occurrence and person id")
add_enrollment(member_id = "M000000401")
add_claim(member_id = "M000000401", claim_id = "C000000000401")
expect_visit_occurrence(person_id = 401, visit_occurrence_id = 401)

declareTest(402, "Visit concept ID")
add_enrollment(member_id = "M000000402")
add_claim(member_id = "M000000402", claim_id = "C000000000402", type_of_claim = "Outpatient")
add_claim(member_id = "M000000402", claim_id = "C000000000403", type_of_claim = "DPC")
add_claim(member_id = "M000000402", claim_id = "C000000000404", type_of_claim = "Inpatientâ€™")
expect_visit_occurrence(person_id = 402, visit_occurrence_id = 402, visit_concept_id = 9202)
expect_visit_occurrence(person_id = 402, visit_occurrence_id = 403, visit_concept_id = 9201)
expect_visit_occurrence(person_id = 402, visit_occurrence_id = 404, visit_concept_id = 9201)

declareTest(403, "Visit start date without other info")
add_enrollment(member_id = "M000000403")
add_claim(member_id = "M000000403", claim_id = "C000000000406", month_and_year_of_medical_care = "201002")
expect_visit_occurrence(person_id = 403, visit_occurrence_id = 406, visit_start_date = "2010-02-15")

declareTest(404, "Visit start date with admission date in month of care")
add_enrollment(member_id = "M000000404")
add_claim(member_id = "M000000404", claim_id = "C000000000407", month_and_year_of_medical_care = "201002", admission_date = "2010-02-05")
expect_visit_occurrence(person_id = 404, visit_occurrence_id = 407, visit_start_date = "2010-02-05")

declareTest(405, "Visit start date with admission date before month of care")
add_enrollment(member_id = "M000000405")
add_claim(member_id = "M000000405", claim_id = "C000000000408", month_and_year_of_medical_care = "201002", admission_date = "2010-01-05")
expect_visit_occurrence(person_id = 405, visit_occurrence_id = 408, visit_start_date = "2010-02-01")

set_defaults_drug(date_of_dispense = NULL, as_needed_medication_flag = NULL,category_of_medical_care = NULL, pharmacy_charge = NULL, drug_charge = NULL, date_of_prescription = NULL)

declareTest(406, "Visit start date with prescription date")
add_enrollment(member_id = "M000000406")
add_claim(member_id = "M000000406", claim_id = "C000000000409", month_and_year_of_medical_care = "201002")
add_drug(member_id = "M000000406", claim_id = "C000000000409", date_of_prescription = "2010-02-05")
expect_visit_occurrence(person_id = 406, visit_occurrence_id = 409, visit_start_date = "2010-02-05")

set_defaults_procedure(procedure_standard_additional_rate = NULL, procedure_standard_price = NULL, date_of_procedure = NULL)

declareTest(407, "Visit start date with procedure date")
add_enrollment(member_id = "M000000407")
add_claim(member_id = "M000000407", claim_id = "C000000000410", month_and_year_of_medical_care = "201002")
add_procedure(member_id = "M000000407", claim_id = "C000000000410", date_of_procedure = "2010-02-05")
expect_visit_occurrence(person_id = 407, visit_occurrence_id = 410, visit_start_date = "2010-02-05")

set_defaults_diagnosis(main_disease_flag = NULL, causative_disease_flag = NULL, suspicion_flag = NULL, outcome_death_flag = NULL, outcome_exacerbation_flag = NULL)

declareTest(408, "Visit start date from start of medical care")
add_enrollment(member_id = "M000000408")
add_claim(member_id = "M000000408", claim_id = "C000000000411", month_and_year_of_medical_care = "201002")
add_diagnosis(member_id = "M000000408", claim_id = "C000000000411", date_of_medical_care_start = "2010-02-08")
expect_visit_occurrence(person_id = 408, visit_occurrence_id = 411, visit_start_date = "2010-02-08")

declareTest(409, "Visit start date when start of medical care before month of care")
add_enrollment(member_id = "M000000409")
add_claim(member_id = "M000000409", claim_id = "C000000000412", month_and_year_of_medical_care = "201002")
add_diagnosis(member_id = "M000000409", claim_id = "C000000000412", date_of_medical_care_start = "2010-01-01")
expect_visit_occurrence(person_id = 409, visit_occurrence_id = 412, visit_start_date = "2010-02-15")

declareTest(410, "Visit end date")
add_enrollment(member_id = "M000000410")
add_claim(member_id = "M000000410", claim_id = "C000000000413", month_and_year_of_medical_care = "201002", days_of_medical_care = 3)
add_claim(member_id = "M000000410", claim_id = "C000000000414", month_and_year_of_medical_care = "201004", days_of_medical_care = 3, admission_date = "2010-04-05")
add_claim(member_id = "M000000410", claim_id = "C000000000415", month_and_year_of_medical_care = "201006", days_of_medical_care = 3, admission_date = "2010-05-05")
add_claim(member_id = "M000000410", claim_id = "C000000000416", month_and_year_of_medical_care = "201008", days_of_medical_care = 3)
add_claim(member_id = "M000000410", claim_id = "C000000000417", month_and_year_of_medical_care = "201010", days_of_medical_care = 3)
add_claim(member_id = "M000000410", claim_id = "C000000000418", month_and_year_of_medical_care = "201012", days_of_medical_care = 3)
add_claim(member_id = "M000000410", claim_id = "C000000000419", month_and_year_of_medical_care = "201102", days_of_medical_care = 3)
add_drug(member_id = "M000000410", claim_id = "C000000000416", date_of_prescription = "2010-08-05")
add_procedure(member_id = "M000000410", claim_id = "C000000000417", date_of_procedure = "2010-10-05")
add_diagnosis(member_id = "M000000410", claim_id = "C000000000418", date_of_medical_care_start = "2010-12-05")
add_diagnosis(member_id = "M000000410", claim_id = "C000000000419", date_of_medical_care_start = "2011-01-08")
expect_visit_occurrence(person_id = 410, visit_occurrence_id = 413, visit_end_date = "2010-02-17")
expect_visit_occurrence(person_id = 410, visit_occurrence_id = 414, visit_end_date = "2010-04-07")
expect_visit_occurrence(person_id = 410, visit_occurrence_id = 415, visit_end_date = "2010-06-03")
expect_visit_occurrence(person_id = 410, visit_occurrence_id = 416, visit_end_date = "2010-08-07")
expect_visit_occurrence(person_id = 410, visit_occurrence_id = 417, visit_end_date = "2010-10-07")
expect_visit_occurrence(person_id = 410, visit_occurrence_id = 418, visit_end_date = "2010-12-07")
expect_visit_occurrence(person_id = 410, visit_occurrence_id = 419, visit_end_date = "2011-02-17")

declareTest(411, "Visit type concept ID")
add_enrollment(member_id = "M000000411")
add_claim(member_id = "M000000411", claim_id = "C000000000420")
expect_visit_occurrence(person_id = 411, visit_occurrence_id = 420, visit_type_concept_id = 44818517)

declareTest(412, "Visit care site ID")
add_enrollment(member_id = "M000000412")
add_claim(member_id = "M000000412", claim_id = "C000000000421", medical_facility_id = "F0000002")
expect_visit_occurrence(person_id = 412, visit_occurrence_id = 421, care_site_id = 10000002)

declareTest(413, "Visit source value")
add_enrollment(member_id = "M000000413")
add_claim(member_id = "M000000413", claim_id = "C000000000422", type_of_claim = "Outpatient")
expect_visit_occurrence(person_id = 413, visit_occurrence_id = 422, visit_source_value = "Outpatient")

declareTest(414, "Visit start date from multiple start of medical care records")
add_enrollment(member_id = "M000000414")
add_claim(member_id = "M000000414", claim_id = "C000000000423", month_and_year_of_medical_care = "201002")
add_diagnosis(member_id = "M000000414", claim_id = "C000000000423", date_of_medical_care_start = "2010-02-08")
add_diagnosis(member_id = "M000000414", claim_id = "C000000000423", date_of_medical_care_start = "2010-02-12")
expect_visit_occurrence(person_id = 414, visit_occurrence_id = 423, visit_start_date = "2010-02-12")

add_claim(member_id = "M000000414", claim_id = "C000000000424", month_and_year_of_medical_care = "201003")
add_diagnosis(member_id = "M000000414", claim_id = "C000000000424", date_of_medical_care_start = "2010-03-08")
add_diagnosis(member_id = "M000000414", claim_id = "C000000000424", date_of_medical_care_start = "2010-03-12", medical_facility_id = "F0000002")
add_diagnosis(member_id = "M000000414", claim_id = "C000000000424", date_of_medical_care_start = "2010-03-10", medical_facility_id = "F0000002")
expect_visit_occurrence(person_id = 414, visit_occurrence_id = 424, visit_start_date = "2010-03-08")

add_claim(member_id = "M000000414", claim_id = "C000000000425", month_and_year_of_medical_care = "201003")
add_diagnosis(member_id = "M000000414", claim_id = "C000000000425", date_of_medical_care_start = "2010-03-12", medical_facility_id = "F0000002")
add_diagnosis(member_id = "M000000414", claim_id = "C000000000425", date_of_medical_care_start = "2010-03-10", medical_facility_id = "F0000002")
expect_visit_occurrence(person_id = 414, visit_occurrence_id = 425, visit_start_date = "2010-03-15")

declareTest(415, "No visit occurrence when claim type is pharmacy")
add_enrollment(member_id = "M000000415")
add_claim(member_id = "M000000415", claim_id = "C000000000426", type_of_claim = "Pharmacy")
expect_no_visit_occurrence(person_id = 415)