# Drug exposure ------------------------------------------------------------------

createDrugExposureTests <- function () {
	declareTest(801, "Drug exposure person ID")
	add_enrollment(member_id = "M000000801")
	add_claim(member_id = "M000000801", claim_id = "C000000000801")
	add_drug(member_id = "M000000801", claim_id = "C000000000801")
	expect_drug_exposure(person_id = 801)

	declareTest(802, "Drug exposure visit occurrence ID")
	add_enrollment(member_id = "M000000802")
	add_claim(member_id = "M000000802", claim_id = "C000000000802")
	add_drug(member_id = "M000000802", claim_id = "C000000000802")
	expect_drug_exposure(visit_occurrence_id = 802)

	declareTest(803, "Drug exposure type concept ID")
	add_enrollment(member_id = "M000000803")
	add_claim(member_id = "M000000803", claim_id = "C000000000803")
	add_drug(member_id = "M000000803", claim_id = "C000000000803", type_of_claim = "Outpatient")
	add_claim(member_id = "M000000803", claim_id = "C000000000804")
	add_drug(member_id = "M000000803", claim_id = "C000000000804", type_of_claim = "Inpatient")
	add_claim(member_id = "M000000803", claim_id = "C000000000805")
	add_drug(member_id = "M000000803", claim_id = "C000000000805", type_of_claim = "DPC")
	add_claim(member_id = "M000000803", claim_id = "C000000000806")
	add_drug(member_id = "M000000803", claim_id = "C000000000806", type_of_claim = "Pharmacy")
	expect_drug_exposure(person_id = 803, visit_occurrence_id = 803, drug_type_concept_id = 32869)
	expect_drug_exposure(person_id = 803, visit_occurrence_id = 804, drug_type_concept_id = 32818)
	expect_drug_exposure(person_id = 803, visit_occurrence_id = 805, drug_type_concept_id = 32818)
	expect_drug_exposure(person_id = 803, visit_occurrence_id = 806, drug_type_concept_id = 32869)

	declareTest(804, "Drug provider from institution ID")
	add_enrollment(member_id = "M000000804")
	add_claim(member_id = "M000000804", claim_id = "C000000000807")
	add_drug(member_id = "M000000804", claim_id = "C000000000807", medical_facility_id = "F0000007")
	expect_drug_exposure(person_id = 804, visit_occurrence_id = 807, provider_id = 10000007)

	declareTest(806, "Drug start date from prescription date")
	add_enrollment(member_id = "M000000806")
	add_claim(member_id = "M000000806", claim_id = "C000000000809")
	add_drug(member_id = "M000000806", claim_id = "C000000000809", date_of_prescription = "2010-01-05")
	expect_drug_exposure(person_id = 806, visit_occurrence_id = 809, drug_exposure_start_date = "2010-01-05")

	declareTest(807, "Drug start date from visit date")
	add_enrollment(member_id = "M000000807")
	add_claim(member_id = "M000000807", claim_id = "C000000000810", month_and_year_of_medical_care = "201002", type_of_claim = "pharmacy")
	add_drug(member_id = "M000000807", claim_id = "C000000000810", date_of_prescription = NULL)
	expect_drug_exposure(person_id = 807, visit_occurrence_id = NULL, drug_exposure_start_date = "2010-02-15")

	declareTest(808, "Drug end date")
	add_enrollment(member_id = "M000000808")
	add_claim(member_id = "M000000808", claim_id = "C000000000811")
	add_claim(member_id = "M000000808", claim_id = "C000000000812")
	add_drug(member_id = "M000000808", claim_id = "C000000000811", date_of_prescription = "2010-01-05", administered_days = 3)
	add_drug(member_id = "M000000808", claim_id = "C000000000812", date_of_prescription = "2010-01-01", administered_days = 365)
	expect_drug_exposure(person_id = 808, visit_occurrence_id = 811, drug_exposure_end_date = "2010-01-07")
	date <- as.character(as.Date("2010-01-01") + 179)
	expect_drug_exposure(person_id = 808, visit_occurrence_id = 812, drug_exposure_end_date = date)

	declareTest(809, "Drug days supply")
	add_enrollment(member_id = "M000000809")
	add_claim(member_id = "M000000809", claim_id = "C000000000813")
	add_claim(member_id = "M000000809", claim_id = "C000000000814")
	add_drug(member_id = "M000000809", claim_id = "C000000000813", administered_days = 3)
	add_drug(member_id = "M000000809", claim_id = "C000000000814", administered_days = 365)
	expect_drug_exposure(person_id = 809, visit_occurrence_id = 813, days_supply = 3)
	expect_drug_exposure(person_id = 809, visit_occurrence_id = 814, days_supply = 180)

	declareTest(810, "Drug concept ID")
	add_enrollment(member_id = "M000000810")
	add_claim(member_id = "M000000810", claim_id = "C000000000815")
	add_drug(member_id = "M000000810", claim_id = "C000000000815", jmdc_drug_code = 100000008105)
	expect_drug_exposure(person_id = 810, visit_occurrence_id = 815, drug_concept_id = 35152527, drug_source_value = "100000008105")

	declareTest(811, "Drug sig")
	add_enrollment(member_id = "M000000811")
	add_claim(member_id = "M000000811", claim_id = "C000000000816")
	add_drug(member_id = "M000000811", claim_id = "C000000000816", as_needed_medication_flag = "1", prescribed_amount_per_day = 1, administered_amount = "20", unit_of_administered_amount = "g")
	expect_drug_exposure(person_id = 811, visit_occurrence_id = 816, sig = "1 g per day as needed, 20 g total")
}