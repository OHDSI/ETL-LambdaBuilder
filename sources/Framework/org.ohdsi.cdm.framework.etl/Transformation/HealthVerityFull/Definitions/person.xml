<QueryDefinition>
  <Query>
	with a as
		(
		SELECT
		ch.person_id as PersonId,
		hvid,
		patient_gender,
		patient_year_of_birth,
		null as date_start,
		null as date_end,
		null as period_type_concept_id,
		data_vendor
		FROM {sc}.enrollment
		JOIN {ch_sc}._chunks ch ON ch.ChunkId = {0} AND hvid = ch.PERSON_SOURCE_VALUE

		union

		SELECT
		ch.person_id as PersonId,
		hvid,
		patient_gender,
		patient_year_of_birth,
		case when date_service is not null
		  and date_part('year', date_service) != 2009 
		  and (logical_delete_reason is null 
		  or logical_delete_reason = '' 
		  or logical_delete_reason = 'null' 
		  or lower(logical_delete_reason) not in ('denied claims', 'reversal to original claim')) 
			then date_service
		end as date_start,
		case when date_service is not null
		  and date_part('year', date_service) != 2009 
		  and (logical_delete_reason is null 
		  or logical_delete_reason = '' 
		  or logical_delete_reason = 'null' 
		  or lower(logical_delete_reason) not in ('denied claims', 'reversal to original claim')) 
			then coalesce(date_service_end, date_service)
		end as date_end,
		case
		  when lower(claim_type) = 'p' then 32871
		  when lower(claim_type) = 'i' then 32810
		  else 32811
		end as period_type_concept_id,
		data_vendor
		FROM {sc}.medical_claims
		JOIN {ch_sc}._chunks ch ON ch.ChunkId = {0} AND hvid = ch.PERSON_SOURCE_VALUE
		
		union

		SELECT
		ch.person_id as PersonId,
		hvid,
		patient_gender,
		patient_year_of_birth,
		case when date_service is not null
		  and date_part('year', date_service) != 2009 
		  and (logical_delete_reason is null 
		  or logical_delete_reason = '' 
		  or logical_delete_reason = 'null')
			then date_service
		end as date_start,
		case when date_service is not null
		  and date_part('year', date_service) != 2009 
		  and (logical_delete_reason is null 
		  or logical_delete_reason = '' 
		  or logical_delete_reason = 'null')
			then date_service
		end as date_end,
		32869 as period_type_concept_id,
		data_vendor
		FROM {sc}.pharmacy_claims
		JOIN {ch_sc}._chunks ch ON ch.ChunkId = {0} AND hvid = ch.PERSON_SOURCE_VALUE
		
		union

		SELECT
		ch.person_id as PersonId,
		hvid,
		patient_gender,
		patient_year_of_birth,
		null as date_start,
		null as date_end,
		NULL as period_type_concept_id,
		data_vendor
		FROM {sc}.events
		JOIN {ch_sc}._chunks ch ON ch.ChunkId = {0} AND hvid = ch.PERSON_SOURCE_VALUE
		)
		select
		  a.*
		from a
		order by 1
    </Query>
  <Persons>
    <PersonDefinition>
      <PersonId>PersonId</PersonId>
      <PersonSourceValue>hvid</PersonSourceValue>
      <Gender>patient_gender</Gender>
      <YearOfBirth>patient_year_of_birth</YearOfBirth>
      <StartDate>date_start</StartDate>
      <EndDate>date_end</EndDate>
      <PeriodTypeConceptId>period_type_concept_id</PeriodTypeConceptId>
      <AdditionalFields>
        <string>data_vendor</string>
      </AdditionalFields>
    </PersonDefinition>
  </Persons>
</QueryDefinition>