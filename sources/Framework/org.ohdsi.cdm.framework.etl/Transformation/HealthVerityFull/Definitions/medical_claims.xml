<QueryDefinition>
	<Query>
    SELECT distinct
    ch.person_id as PersonId,
    hvid,
    date_service,
    trim(replace(replace(replace(diagnosis_code, chr(9), ' '), chr(10), ' '), chr(13), ' ')) diagnosis_code,
    trim(replace(replace(replace(procedure_code, chr(9), ' '), chr(10), ' '), chr(13), ' ')) procedure_code,
    ndc_code,
    claim_type,

		CAST(COALESCE(
		CASE WHEN prov_rendering_npi ~ '^[0-9]+$' AND length(prov_rendering_npi) &lt;= 10 THEN prov_rendering_npi ELSE NULL END,
		CASE WHEN prov_billing_npi ~ '^[0-9]+$' AND length(prov_billing_npi) &lt;= 10 THEN prov_billing_npi ELSE NULL END,
		CASE WHEN prov_referring_npi ~ '^[0-9]+$' AND length(prov_referring_npi) &lt;= 10 THEN prov_referring_npi ELSE NULL END
		) as BIGINT) as provider_id,
		CAST(CASE WHEN prov_facility_npi ~ '^[0-9]+$' AND length(prov_facility_npi) &lt;= 10 THEN prov_facility_npi ELSE NULL END as BIGINT) as care_site_id,

    case
    when lower(claim_type) = 'p' then 32871
    when lower(claim_type) = 'i' then 32810
    when claim_type is NULL then 32811
    end as type_concept_id,

    coalesce(diagnosis_priority, '') || '|' || coalesce(admit_diagnosis_ind, '') as condition_status_source_value,
    case when diagnosis_priority = '1'
    then 32902
    when (diagnosis_priority != '1' OR diagnosis_priority IS NULL) AND coalesce(admit_diagnosis_ind, '') = 'Y'
    then 32890
    when diagnosis_priority IN ('2', '3', '4') AND coalesce(admit_diagnosis_ind, '') != 'Y'
    then 32908
    else 0
    end as condition_status_concept_id,

    COALESCE(procedure_modifier_1,  procedure_modifier_2,  procedure_modifier_3,  procedure_modifier_4) as modifier_source_value,

    COALESCE(inst_type_of_bill_std_id, ' ') as inst_type_of_bill_std_id,
    COALESCE(place_of_service_std_id, ' ') as place_of_service_std_id,
    case
    when date_service_end is null then date_service
    else date_service_end
    end as end_date,
    case
    when length(inst_admit_source_std_id) &gt;= 2
    and substring(inst_admit_source_std_id, 1, 1) = '0'
    and substring(inst_admit_source_std_id, 2, 1) ~ '[0-9]'
    then substring(inst_admit_source_std_id, 2)
    else inst_admit_source_std_id
    end as inst_admit_source_std_id,
    inst_discharge_status_std_id,
    data_vendor,

    case
    when diagnosis_code_qual = '02' then '10'
    when diagnosis_code_qual = '01' then '9'
    when date_service &lt; '10/1/2015' then '9'
		when date_service &gt;= '10/1/2015' then '10'
		end as icd_ver,
		hv_enc_id,
		1 as fake
		FROM {sc}.medical_claims
		JOIN {ch_sc}._chunks ch ON ch.ChunkId = {0} AND hvid = ch.PERSON_SOURCE_VALUE
		where  date_service is not null and date_part('year', date_service) &gt;= 2009 and
		(logical_delete_reason is null or logical_delete_reason = '' or logical_delete_reason = 'null' or lower(logical_delete_reason) not in ('denied claims', 'reversal to original claim'))
		order by ch.person_id
	</Query>
	<ConditionOccurrence>
		<ConditionOccurrenceDefinition>
			<IsUnique>true</IsUnique>
			<Condition>{icd_ver} = 9</Condition>
			<PersonId>PersonId</PersonId>
			<StartDate>date_service</StartDate>
      <EndDate>date_service</EndDate>
      <ProviderId>provider_id</ProviderId>
			<AdditionalFields>
				<string>data_vendor</string>
			</AdditionalFields>
			<Concepts>
				<Concept>
					<ConceptIdMappers>
						<Mapper>
							<Lookup>icd9</Lookup>
						</Mapper>
					</ConceptIdMappers>
					<Fields>
						<Field key="diagnosis_code" typeId="type_concept_id"/>
					</Fields>
				</Concept>
				<Concept>
					<Fields>
						<Field conceptId="condition_status_concept_id" sourceKey="condition_status_source_value" defaultTypeId="0"/>
					</Fields>
				</Concept>
			</Concepts>
		</ConditionOccurrenceDefinition>
		<ConditionOccurrenceDefinition>
			<IsUnique>true</IsUnique>
			<Condition>{icd_ver} = 10</Condition>
			<PersonId>PersonId</PersonId>
			<StartDate>date_service</StartDate>
      <EndDate>date_service</EndDate>
      <ProviderId>provider_id</ProviderId>
			<AdditionalFields>
				<string>data_vendor</string>
			</AdditionalFields>
			<Concepts>
				<Concept>
					<ConceptIdMappers>
						<Mapper>
							<Lookup>icd10</Lookup>
						</Mapper>
					</ConceptIdMappers>
					<Fields>
						<Field key="diagnosis_code" typeId="type_concept_id"/>
					</Fields>
				</Concept>
				<Concept>
					<Fields>
            <Field conceptId="condition_status_concept_id" sourceKey="condition_status_source_value" defaultTypeId="0"/>
					</Fields>
				</Concept>
			</Concepts>
		</ConditionOccurrenceDefinition>
	</ConditionOccurrence>
	<ProcedureOccurrence>
		<ProcedureOccurrenceDefinition>
			<IsUnique>true</IsUnique>
			<PersonId>PersonId</PersonId>
			<StartDate>date_service</StartDate>
			<EndDate>date_service</EndDate>
      <ProviderId>provider_id</ProviderId>
			<AdditionalFields>
				<string>data_vendor</string>
			</AdditionalFields>
			<Concepts>
				<Concept>
					<ConceptIdMappers>
						<Mapper>
							<Lookup>procedure</Lookup>
						</Mapper>
					</ConceptIdMappers>
					<Fields>
						<Field key="procedure_code" typeId="type_concept_id" />
					</Fields>
				</Concept>
        <Concept>
          <ConceptIdMappers>
            <Mapper>
              <Lookup>procedure</Lookup>
            </Mapper>
          </ConceptIdMappers>
          <Fields>
            <Field key="modifier_source_value" />
          </Fields>
        </Concept>
			</Concepts>
		</ProcedureOccurrenceDefinition>
	</ProcedureOccurrence>
	<DrugExposure>
		<DrugExposureDefinition>
			<IsUnique>true</IsUnique>
			<PersonId>PersonId</PersonId>
			<StartDate>date_service</StartDate>
			<EndDate>date_service</EndDate>
      <ProviderId>provider_id</ProviderId>
			<AdditionalFields>
				<string>data_vendor</string>
			</AdditionalFields>
			<Concepts>
				<Concept>
					<ConceptIdMappers>
						<Mapper>
							<Lookup>ndc</Lookup>
						</Mapper>
					</ConceptIdMappers>
					<Fields>
						<Field key="ndc_code" typeId="type_concept_id" eventDate="date_service" />
					</Fields>
				</Concept>
			</Concepts>
		</DrugExposureDefinition>
	</DrugExposure>
	<VisitOccurrence>
		<!-- fake definition, only to load CMSPlaceOfService lookup for Visit Concept Roll-up Logic  -->
		<VisitOccurrenceDefinition>
			<Condition>{fake} = 0</Condition>
			<PersonId>PersonId</PersonId>
			<Concepts>
				<Concept>
					<ConceptIdMappers>
						<Mapper>
							<Lookup>CMSPlaceOfService</Lookup>
						</Mapper>
					</ConceptIdMappers>
					<Fields>
						<Field key="fake" typeId="1" sourceKey="fake"/>
					</Fields>
				</Concept>
			</Concepts>
		</VisitOccurrenceDefinition>
		<VisitOccurrenceDefinition>
			<IsUnique>true</IsUnique>
			<Condition>{type_concept_id} = 32810</Condition>
			<PersonId>PersonId</PersonId>
      <ProviderId>provider_id</ProviderId>
      <CareSiteId>care_site_id</CareSiteId>
			<StartDate>date_service</StartDate>
			<EndDate>end_date</EndDate>
			<AdditionalFields>
				<string>data_vendor</string>
				<string>hv_enc_id</string>
			</AdditionalFields>
			<Concepts>
				<Concept>
					<ConceptIdMappers>
						<Mapper>
							<Lookup>ub04</Lookup>
						</Mapper>
					</ConceptIdMappers>
					<Fields>
						<Field key="inst_type_of_bill_std_id" typeId="type_concept_id" defaultConceptId="9202"/>
					</Fields>
				</Concept>
        <Concept>
          <ConceptIdMappers>
            <Mapper>
              <Lookup>ub04ds</Lookup>
            </Mapper>
          </ConceptIdMappers>
          <Fields>
            <Field key="inst_discharge_status_std_id" defaultTypeId="0"/>
          </Fields>
        </Concept>
        <Concept>
          <ConceptIdMappers>
            <Mapper>
              <Lookup>ub04po</Lookup>
            </Mapper>
          </ConceptIdMappers>
          <Fields>
            <Field key="inst_admit_source_std_id" defaultTypeId="0"/>
          </Fields>
        </Concept>
			</Concepts>
		</VisitOccurrenceDefinition>
		<VisitOccurrenceDefinition>
			<IsUnique>true</IsUnique>
			<Condition>{type_concept_id} = 32871</Condition>
			<PersonId>PersonId</PersonId>
      <ProviderId>provider_id</ProviderId>
      <CareSiteId>care_site_id</CareSiteId>
			<StartDate>date_service</StartDate>
			<EndDate>end_date</EndDate>
			<AdditionalFields>
				<string>data_vendor</string>
				<string>hv_enc_id</string>
			</AdditionalFields>
			<Concepts>
				<Concept>
					<ConceptIdMappers>
						<Mapper>
							<Lookup>cms</Lookup>
						</Mapper>
					</ConceptIdMappers>
					<Fields>
						<Field key="place_of_service_std_id"  typeId="type_concept_id" defaultConceptId="9202"/>
					</Fields>
				</Concept>
        <Concept>
          <ConceptIdMappers>
            <Mapper>
              <Lookup>ub04ds</Lookup>
            </Mapper>
          </ConceptIdMappers>
          <Fields>
            <Field key="inst_discharge_status_std_id" defaultTypeId="0"/>
          </Fields>
        </Concept>
        <Concept>
          <ConceptIdMappers>
            <Mapper>
              <Lookup>ub04po</Lookup>
            </Mapper>
          </ConceptIdMappers>
          <Fields>
            <Field key="inst_admit_source_std_id" defaultTypeId="0"/>
          </Fields>
        </Concept>
			</Concepts>
		</VisitOccurrenceDefinition>
    <VisitOccurrenceDefinition>
      <IsUnique>true</IsUnique>
      <Condition>{type_concept_id} = 32811</Condition>
      <PersonId>PersonId</PersonId>
      <ProviderId>provider_id</ProviderId>
      <CareSiteId>care_site_id</CareSiteId>
      <StartDate>date_service</StartDate>
      <EndDate>end_date</EndDate>
      <AdditionalFields>
        <string>data_vendor</string>
        <string>hv_enc_id</string>
      </AdditionalFields>
      <Concepts>
        <Concept>
          <Fields>
            <Field defaultConceptId="0" defaultSource=" " defaultTypeId="32811"/>
          </Fields>
        </Concept>
        <Concept>
          <ConceptIdMappers>
            <Mapper>
              <Lookup>ub04ds</Lookup>
            </Mapper>
          </ConceptIdMappers>
          <Fields>
            <Field key="inst_discharge_status_std_id" defaultTypeId="0"/>
          </Fields>
        </Concept>
        <Concept>
          <ConceptIdMappers>
            <Mapper>
              <Lookup>ub04po</Lookup>
            </Mapper>
          </ConceptIdMappers>
          <Fields>
            <Field key="inst_admit_source_std_id" defaultTypeId="0"/>
          </Fields>
        </Concept>
      </Concepts>
    </VisitOccurrenceDefinition>
	</VisitOccurrence>
</QueryDefinition>