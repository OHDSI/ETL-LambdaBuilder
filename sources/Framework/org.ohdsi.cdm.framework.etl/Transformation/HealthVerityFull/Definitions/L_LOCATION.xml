<QueryDefinition>
	<Query>
		with l as
		(
		SELECT patient_state, patient_zip3
		FROM {sc}.enrollment
		where COALESCE(NULLIF(patient_state, ''), NULLIF(patient_zip3, '')) is not null
		UNION
		SELECT patient_state, patient_zip3
		FROM {sc}.medical_claims
		where COALESCE(NULLIF(patient_state, ''), NULLIF(patient_zip3, '')) is not null
		UNION
		SELECT patient_state, patient_zip3
		FROM {sc}.pharmacy_claims
		where COALESCE(NULLIF(patient_state, ''), NULLIF(patient_zip3, '')) is not null
		UNION
		SELECT patient_state, patient_zip3
		FROM {sc}.events
		where COALESCE(NULLIF(patient_state, ''), NULLIF(patient_zip3, '')) is not null
		),
		ids as (
		select
		DECODE(patient_state,
			'AK', 1,
			'AL', 2,
			'AR', 3,
			'AZ', 4,
			'CA', 5,
			'CO', 6,
			'CT', 7,
			'DC', 8,
			'DE', 9,
			'FL', 10,
			'GA', 11,
			'HI', 12,
			'IA', 13,
			'ID', 14,
			'IL', 15,
			'IN', 16,
			'KS', 17,
			'KY', 18,
			'LA', 19,
			'MA', 20,
			'MD', 21,
			'ME', 22,
			'MI', 23,
			'MN', 24,
			'MO', 25,
			'MS', 26,
			'MT', 27,
			'NC', 28,
			'ND', 29,
			'NE', 30,
			'NH', 31,
			'NJ', 32,
			'NM', 33,
			'NV', 34,
			'NY', 35,
			'OH', 36,
			'OK', 37,
			'OR', 38,
			'PA', 39,
			'PR', 40,
			'RI', 41,
			'SC', 42,
			'SD', 43,
			'TN', 44,
			'TX', 45,
			'UT', 46,
			'VA', 47,
			'VT', 48,
			'WA', 49,
			'WI', 50,
			'WV', 51,
			'WY', 52,
			0
		  )*1000000
		  +
		  coalesce(CASE 
			  WHEN LENGTH(patient_zip3) = 1 THEN ASCII(SUBSTRING(patient_zip3, 1, 1))
			  WHEN LENGTH(patient_zip3) = 2 THEN ASCII(SUBSTRING(patient_zip3, 1, 1)) * 100 + ASCII(SUBSTRING(patient_zip3, 2, 1))
			  WHEN LENGTH(patient_zip3) >= 3 THEN ASCII(SUBSTRING(patient_zip3, 1, 1)) * 10000 + ASCII(SUBSTRING(patient_zip3, 2, 1)) * 100 + ASCII(SUBSTRING(patient_zip3, 3, 1))
		  end, 0) as location_id,
		  patient_state,
		  patient_zip3
		  from l
		)
		select
		location_id,
		patient_state,
		patient_zip3,
		COALESCE(patient_state, '') || '|' || COALESCE(patient_zip3, '') AS source_value,
		42046186 AS country_concept_id,
		'United States of America' AS country_source_value
		from ids
	</Query>
	<Locations>
		<LocationDefinition>
			<Id>location_id</Id>
			<State>patient_state</State>
			<SourceValue>source_value</SourceValue>
			<Zip>patient_zip3</Zip>
			<CountryConceptId>country_concept_id</CountryConceptId>
			<CountrySourceValue>country_source_value</CountrySourceValue>
		</LocationDefinition>
	</Locations>
</QueryDefinition>