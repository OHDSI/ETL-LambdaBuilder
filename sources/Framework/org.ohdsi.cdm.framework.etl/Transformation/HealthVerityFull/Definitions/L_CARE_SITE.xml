<QueryDefinition>
   <Query>
		select
		cast(care_site_source_value as INT) as care_site_id, care_site_source_value, care_site_name, place_of_service_source_value
		from
		(
		select ROW_NUMBER() OVER(PARTITION BY care_site_source_value ORDER BY rnk) AS rn2, *  from
		(
		with cte_sites as (
		  select distinct prov_facility_npi, prov_facility_name_1, place_of_service_std_id
		  from {sc}.medical_claims
		  where prov_facility_npi is not NULL
		),
		cte_facility_name AS (
			SELECT 
				prov_facility_npi,
				CASE 
					WHEN COUNT(DISTINCT prov_facility_name_1) > 1 THEN NULL
					ELSE MAX(prov_facility_name_1)
				END AS prov_facility_name_1
			FROM cte_sites
			GROUP BY prov_facility_npi
		),
		cte_place_of_service as (
			SELECT 
				prov_facility_npi,
				CASE 
					WHEN COUNT(DISTINCT place_of_service_std_id) > 1 THEN NULL
					ELSE MAX(place_of_service_std_id)
				END AS place_of_service_std_id
			FROM cte_sites
			GROUP BY prov_facility_npi
		)
		select
			s.prov_facility_npi as care_site_source_value,
			f.prov_facility_name_1 AS care_site_name,
			p.place_of_service_std_id AS place_of_service_source_value,
			1 as rnk
		FROM (SELECT DISTINCT prov_facility_npi FROM cte_sites) s
		LEFT JOIN cte_facility_name f ON s.prov_facility_npi = f.prov_facility_npi
		LEFT JOIN cte_place_of_service p ON s.prov_facility_npi = p.prov_facility_npi
		union ALL
		select distinct
		  pharmacy_npi as care_site_source_value,
		  null as care_site_name,
		  '01' as place_of_service_source_value,
		  2 as rnk
		from
		  {sc}.pharmacy_claims
		where
		  pharmacy_npi is not null
		)
		)
		where rn2 = 1
   </Query>
   <CareSites>
      <CareSiteDefinition>
         <Id>care_site_id</Id>
         <Name>care_site_name</Name>
         <CareSiteSourceValue>care_site_source_value</CareSiteSourceValue>
         <Concepts>
            <Concept>
                 <ConceptIdMappers>
                     <Mapper>
                         <Lookup>cms</Lookup>
                     </Mapper>
                 </ConceptIdMappers>
                 <Fields>
                     <Field key="place_of_service_source_value"/>
                 </Fields>
             </Concept>
         </Concepts>
      </CareSiteDefinition>
   </CareSites>
</QueryDefinition>