<QueryDefinition>
   <Query>
    select ROW_NUMBER() OVER(ORDER BY care_site_source_value) AS care_site_id, *  from
    (
    WITH ranked_facilities AS (
        SELECT 
            prov_facility_npi, 
            prov_facility_name_1, 
            place_of_service_std_id,
            ROW_NUMBER() OVER (PARTITION BY prov_facility_npi, prov_facility_name_1 ORDER BY prov_facility_name_1) AS name_row,
            ROW_NUMBER() OVER (PARTITION BY prov_facility_npi, place_of_service_std_id ORDER BY place_of_service_std_id) AS service_row,
            ROW_NUMBER() OVER (PARTITION BY prov_facility_npi ORDER BY prov_facility_name_1, place_of_service_std_id) AS rn
        FROM 
            {sc}.medical_claims
        WHERE 
            prov_facility_npi IS NOT NULL
    )
    SELECT 
        prov_facility_npi as care_site_source_value,
        CASE 
            WHEN MAX(name_row) OVER (PARTITION BY prov_facility_npi) = 1 THEN prov_facility_name_1
            ELSE NULL
        END as care_site_name,
        CASE 
            WHEN MAX(service_row) OVER (PARTITION BY prov_facility_npi) = 1 THEN place_of_service_std_id
            ELSE NULL
        END AS place_of_service_source_value
    FROM 
        ranked_facilities
    WHERE 
        rn = 1
    union ALL
    select distinct
      'Pharmacy NPI: ' || cast(pharmacy_npi as VARCHAR) as care_site_source_value,
      null as care_site_name,
      '01' as place_of_service_source_value
    from
      {sc}.pharmacy_claims
    where
      pharmacy_npi is not null
    )
   </Query>
   <CareSites>
      <CareSiteDefinition>
         <Id>care_site_id</Id>
         <Name>care_site_name</Name>
         <CareSiteSourceValue>care_site_source_value</CareSiteSourceValue>
         <Concepts>
            <Concept>
                 <ConceptIdMappers>
                     <Mapper>
                         <Lookup>cms</Lookup>
                     </Mapper>
                 </ConceptIdMappers>
                 <Fields>
                     <Field key="place_of_service_source_value"/>
                 </Fields>
             </Concept>
         </Concepts>
      </CareSiteDefinition>
   </CareSites>
</QueryDefinition>