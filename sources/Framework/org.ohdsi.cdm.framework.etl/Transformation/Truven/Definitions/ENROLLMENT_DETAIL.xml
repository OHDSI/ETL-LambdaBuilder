<QueryDefinition>
  <Variables>
    <Variable name="prefix" database="ccae">Commercial</Variable>
    <Variable name="prefix" database="mdcr">Medicare</Variable>
    <Variable name="vendor" database="ccae">'ccae' as vendor</Variable>
    <Variable name="vendor" database="mdcr">'mdcr' as vendor</Variable>
    <Variable name="vendor" database="mdcd">'mdcd' as vendor</Variable>
  </Variables>
   <Query database="ccae,mdcr">
WITH a AS (
    SELECT 
        ENROLID,
        SEX,
        DOBYR,
        DTSTART,
        DTEND,
        SUBSTRING(RIGHT('00000000000' + CAST(ENROLID AS VARCHAR), 11), 1, 9) AS Family,
        CASE PLANTYP
            WHEN 1 THEN '{prefix} Basic/Major Medical'
            WHEN 2 THEN '{prefix} Comprehensive'
            WHEN 3 THEN '{prefix} EPO'
            WHEN 4 THEN '{prefix} HMO'
            WHEN 5 THEN '{prefix} POS'
            WHEN 6 THEN '{prefix} PPO'
            WHEN 7 THEN '{prefix} POS with Capitation'
            WHEN 8 THEN '{prefix} CDHP'
            WHEN 9 THEN '{prefix} HDHP'
            ELSE '{prefix} Other'
        END AS ps,
        DATATYP,
        EGEOLOC,
        32813 AS PeriodTypeConceptId,
        ISNULL(MHSACOVG, '0') AS VALUE_AS_NUMBER,
        CASE WHEN RX = '1' THEN 0 ELSE 1 END AS missinginsurance,
        RX
    FROM {sc}.ENROLLMENT_DETAIL t1
    JOIN {ch_sc}._chunks ch ON ch.ChunkId = {0} AND ENROLID = ch.person_source_value
)

, b as
(
SELECT 
	  t1.ENROLID
	, SUBSTRING(RIGHT('00000000000' + CAST(t1.ENROLID AS VARCHAR), 11), 1, 9) as family
	, MIN(t1.DOBYR) DOBYR
	, MIN(CAST(CAST(t1.DOBYR AS VARCHAR) + '-' + CAST(DATEPART(MONTH, t1.DTSTART) AS VARCHAR) + '-01' AS DATE)) DOBYR_DATE
FROM {sc}.ENROLLMENT_DETAIL t1
JOIN {ch_sc}._chunks ch ON ch.ChunkId = {0} AND ENROLID = ch.person_source_value
WHERE 1=1
AND t1.RX = '1' 
AND t1.DOBYR = DATEPART(YEAR, t1.DTSTART
GROUP BY t1.ENROLID
)

SELECT DISTINCT
    a.*,
    CASE
        WHEN a.DATATYP IN (2, 4) THEN 'C '
        ELSE 'N '
    END + ps AS PayerSource,
    900000010 AS OBSERVATION_CONCEPT_ID,
    'MHSACOVG' AS OBSERVATION_SOURCE_VALUE,
    'ccae' AS vendor,
    NULL AS PLANKEY,
    NULL AS RACE_SOURCE_VALUE,
    NULL AS RACE_CONCEPT_ID,
    NULL AS ETHNICITY_SOURCE_VALUE,
    NULL AS ETHNICITY_CONCEPT_ID,
    b.ENROLID AS baby_person_id,
    b.DOBYR_DATE AS baby_dob
FROM a
LEFT JOIN b
ON a.SEX = '2'
AND a.RX = '1'
AND a.FAMILY = b.FAMILY
AND b.DOBYR - a.DOBYR >= 12
AND a.ENROLID != b.ENROLID
ORDER BY ENROLID
   </Query>
   <Persons>
      <PersonDefinition>
         <PersonId>ENROLID</PersonId>
         <PersonSourceValue>ENROLID</PersonSourceValue>
         <StartDate>DTSTART</StartDate>
         <EndDate>DTEND</EndDate>
         <Gender>SEX</Gender>
         <YearOfBirth>DOBYR</YearOfBirth>
         <Location>EGEOLOC</Location>
         <Race>RACE_SOURCE_VALUE</Race>
         <RaceConceptId>RACE_CONCEPT_ID</RaceConceptId>
         <Ethnicity>ETHNICITY_SOURCE_VALUE</Ethnicity>
         <EthnicityConceptId>ETHNICITY_CONCEPT_ID</EthnicityConceptId>
         <PeriodTypeConceptId>PeriodTypeConceptId</PeriodTypeConceptId>
         <PotentialChildId>baby_person_id</PotentialChildId>
         <PotentialChildBirthDate>baby_dob</PotentialChildBirthDate>
         <AdditionalFields>
           <string>vendor</string>
           <string>missinginsurance</string>
         </AdditionalFields>
      </PersonDefinition>
   </Persons>
   <PayerPlanPeriods>
      <PayerPlanPeriodDefinition>
         <PersonId>ENROLID</PersonId>
         <StartDate>DTSTART</StartDate>
         <EndDate>DTEND</EndDate>
         <PayerSource>PayerSource</PayerSource>
         <PlanSource>PLANKEY</PlanSource>
         <FamilySource>Family</FamilySource>
         <AdditionalFields>
           <string>vendor</string>
         </AdditionalFields>
      </PayerPlanPeriodDefinition>
   </PayerPlanPeriods>
   <Observation>
    <ObservationDefinition>
      <IsUnique>true</IsUnique>
      <PersonId>ENROLID</PersonId>
      <StartDate>DTEND</StartDate>
      <ValuesAsNumber>
        <string>VALUE_AS_NUMBER</string>
      </ValuesAsNumber>
      <AdditionalFields>
        <string>vendor</string>
      </AdditionalFields>
      <Concepts>
        <Concept>
          <Fields>
            <Field conceptId="OBSERVATION_CONCEPT_ID" sourceKey="OBSERVATION_SOURCE_VALUE" defaultTypeId="900000009"/>
          </Fields>
        </Concept>
      </Concepts>
    </ObservationDefinition>
  </Observation>
</QueryDefinition>