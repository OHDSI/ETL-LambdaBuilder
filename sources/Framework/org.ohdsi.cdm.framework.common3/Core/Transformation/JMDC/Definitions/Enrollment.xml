<QueryDefinition>
  <Query>
		with min_max as
		(
		SELECT 1 as id, MIN(month_and_year_of_medical_care) as min_date, MAX(month_and_year_of_medical_care) as max_date
		FROM {sc}.claim
		)

		SELECT CAST(RIGHT(Member_ID, LEN(Member_ID) - 1) AS BIGINT) AS person_id,
		Member_ID AS person_source_value,
		year_of_birth_of_member AS year_of_birth,
		lower(Gender_of_member) AS gender_source_value,
		CASE WHEN month_and_year_of_entry &lt; mm.min_date
    THEN CAST(CAST(mm.min_date AS VARCHAR(6)) + '01' AS DATE)
    ELSE CAST(CAST(month_and_year_of_entry AS VARCHAR(6)) + '01' AS DATE)
    END AS observation_period_start_date,
    CASE
    WHEN month_and_year_of_withdrawal IS NULL
    OR month_and_year_of_withdrawal > mm.max_date
    THEN DATEADD(DAY, - 1, DATEADD(MONTH, 1, CAST(CAST(mm.max_date AS VARCHAR(6)) + '01' AS DATE)))
    ELSE DATEADD(DAY, - 1, DATEADD(MONTH, 1, CAST(CAST(month_and_year_of_withdrawal AS VARCHAR(6)) + '01' AS DATE)))
    END AS observation_period_end_date,
    CASE
    WHEN death_flag = 1 THEN 1
    ELSE 0
    END as died,
    32813 as PeriodTypeConceptId
    FROM {sc}.Enrollment e
    join min_max as mm on 1 = mm.id
    JOIN {ch_sc}._chunks ch ON ch.ChunkId = {0} AND e.Member_ID = ch.PERSON_SOURCE_VALUE
    order by CAST(RIGHT(Member_ID, LEN(Member_ID) - 1) AS BIGINT)
  </Query>
  <Persons>
    <PersonDefinition>
      <PersonId>PERSON_ID</PersonId>
      <PersonSourceValue>person_source_value</PersonSourceValue>
      <StartDate>observation_period_start_date</StartDate>
      <EndDate>observation_period_end_date</EndDate>
      <Gender>gender_source_value</Gender>
      <YearOfBirth>year_of_birth</YearOfBirth>
      <PeriodTypeConceptId>PeriodTypeConceptId</PeriodTypeConceptId>
    </PersonDefinition>
  </Persons>
  <Death>
    <DeathDefinition>
      <Condition>{died} = 1</Condition>
      <PersonId>PERSON_ID</PersonId>
      <StartDate>observation_period_end_date</StartDate>
      <Concepts>
        <Concept>
          <Fields>
            <Field defaultConceptId="1" defaultTypeId="32815"/>
          </Fields>
        </Concept>
      </Concepts>
    </DeathDefinition>
  </Death>
</QueryDefinition>